
#include "dds.h"

// DSS definitions
//short                   dds_table[cLUT_SIZE];   // dds waweform
unsigned short          ph_adder;               // phase adder
static unsigned short   ph_acc=0;               // phase accumulator

#define DDS_PHADDER     (0.3372192f)      		// (22100/65536L)
#define ddsstep         0.024543692f            // 2pi/256

const short dds_table[]={
	0,804,1608,2410,3212,4011,4808,5602,6393,7179,7962,8739,9512,10278,11039,11793,
	12539,13279,14010,14732,15446,16151,16846,17530,18204,18868,19519,20159,20787,21403,22005,22594,
	23170,23731,24279,24811,25329,25832,26319,26790,27245,27683,28105,28510,28898,29268,29621,29956,
	30273,30571,30852,31113,31356,31580,31785,31971,32137,32285,32412,32521,32609,32678,32728,32757,
	32767,32757,32728,32678,32609,32521,32412,32285,32137,31971,31785,31580,31356,31113,30852,30571,
	30273,29956,29621,29268,28898,28510,28105,27683,27245,26790,26319,25832,25329,24811,24279,23731,
	23170,22594,22005,21403,20787,20159,19519,18868,18204,17530,16846,16151,15446,14732,14010,13279,
	12539,11793,11039,10278,9512,8739,7962,7179,6393,5602,4808,4011,3212,2410,1608,804,
	0,-804,-1608,-2410,-3212,-4011,-4808,-5602,-6393,-7179,-7962,-8739,-9512,-10278,-11039,-11793,
	-12539,-13279,-14010,-14732,-15446,-16151,-16846,-17530,-18204,-18868,-19519,-20159,-20787,-21403,-22005,-22594,
	-23170,-23731,-24279,-24811,-25329,-25832,-26319,-26790,-27245,-27683,-28105,-28510,-28898,-29268,-29621,-29956,
	-30273,-30571,-30852,-31113,-31356,-31580,-31785,-31971,-32137,-32285,-32412,-32521,-32609,-32678,-32728,-32757,
	-32767,-32757,-32728,-32678,-32609,-32521,-32412,-32285,-32137,-31971,-31785,-31580,-31356,-31113,-30852,-30571,
	-30273,-29956,-29621,-29268,-28898,-28510,-28105,-27683,-27245,-26790,-26319,-25832,-25329,-24811,-24279,-23731,
	-23170,-22594,-22005,-21403,-20787,-20159,-19519,-18868,-18204,-17530,-16846,-16151,-15446,-14732,-14010,-13279,
	-12539,-11793,-11039,-10278,-9512,-8739,-7962,-7179,-6393,-5602,-4808,-4011,-3212,-2410,-1608,-804
};

/**
* Initialize the LUT and frequency value.
*/
void ddsInit( unsigned int freq)
{

#if 0
    int x;

    float phase = 0.0;                    // for soft DDS init calculations

    // generate the sin table.
    for(x=0; x<cLUT_SIZE; x++) {
        dds_table[x] = (short)((sin(phase)) * 32767);
        phase += ddsstep;
    }
#endif
    //
    dds_setFreq( freq);
}

unsigned int dds_setFreq( unsigned int freq)
{
    // check the freq.
    if ( freq==0)
        freq=cDDS_INITFREQ;     // load the default value if freq is zero.
    else {
        //if ( freq > cDDS_SAMPLINGRATE/2) freq = cDDS_SAMPLINGRATE/2;
    	if ( freq > cDDS_SAMPLINGRATE/2) freq = cDDS_LOWFREQ;
        if ( freq < cDDS_LOWFREQ) freq = cDDS_LOWFREQ;
    }
    //
    ph_adder = (int)(freq/DDS_PHADDER);
    //
    return freq;
}

unsigned short dds_sample( void)
{
    unsigned short tmp;

    ph_acc += ph_adder;

    tmp = (dds_table[(ph_acc >>8)&0x00FF] - 32768);

    return tmp;
}


